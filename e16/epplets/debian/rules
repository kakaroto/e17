#!/usr/bin/make -f

export DH_COMPAT=2

vpath build debian/pmt/
vpath install debian/pmt/
cfg = --prefix=/usr --mandir=/usr/share/man
pwd := $(shell pwd)

SHELL = /bin/sh -e
INSTALL = /usr/bin/install -o root -g root

build:
	dh_testdir
	test -x autogen.sh && ./autogen.sh $(cfg)  || ./configure $(cfg)
	
	# temp dir
	$(INSTALL) -d debian/pmt
	
	cp libtool debian/pmt/libtool
	sed \
	-e 's/^hardcode_libdir_flag_spec.*$$/hardcode_libdir_flag_spec="-D__LIBTOOL_IS_A_FOOL__ "/' \
	-e '/^archive_cmds="/s/"$$/ \\$$deplibs"/' debian/pmt/libtool > libtool
	
	# the configure script anal, hardcodes $EBIN and $EROOT from the running
	# environment into the Makefile, so we hijack those variables beforehand
	export EBIN=usr/bin; \
	export EROOT=$(pwd)/debian/epplets/usr/share/enlightenment; \
	$(MAKE)
	
	touch debian/pmt/$@

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp
	-$(MAKE) -k clean distclean
	-rm -rf debian/pmt
	dh_clean

install: build
	dh_testdir 
	dh_testroot 
	dh_clean -k
	dh_installdirs 

	# parts shamelessly stolen from the bz2 package

	# bin package, epplets
	$(MAKE) install DESTDIR=$(pwd)/debian/epplets/

	# dev package, libepplet-dev
	$(INSTALL) -d debian/libepplet-dev/usr/lib
	mv -v debian/epplets/usr/lib/libepplet.{so,a} debian/libepplet-dev/usr/lib
	mv -v debian/epplets/usr/include debian/libepplet-dev/usr/include

	# lib package, libepplets0
	$(INSTALL) -d debian/libepplet0/usr/lib
	mv -v debian/epplets/usr/lib/libepplet.so.???* debian/libepplet0/usr/lib/
	mv -v debian/epplets/usr/lib/libepplet.so* debian/libepplet0/usr/lib/
	chmod -x debian/libepplet0/usr/lib/*
	
	# remove leftovers
	rm -rfv debian/epplets/usr/lib/
	
	touch debian/pmt/$@


binary-arch: build install
	dh_testdir 
	dh_testroot 
	dh_installdocs
	dh_installmenu 
	dh_undocumented
	dh_installchangelogs 
	dh_strip 
	dh_compress 
	dh_fixperms 
	dh_installdeb 
	# these will generate a lot of harmless warnings, I don't bother
	# to hide them and don't quite know how to fix them
	dh_makeshlibs -V
	dh_shlibdeps -l'pwd'
	dh_gencontrol 
	dh_md5sums 
	dh_builddeb 

binary-indep:

binary: binary-arch

.PHONY: clean binary-indep binary-arch binary
