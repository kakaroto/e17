#!/usr/bin/env python
import ecore.evas
import ecore
import edje
import sys
import os
import serial

#Setup Window
if len(sys.argv) < 4:
	print 'Usage: ardy [Edje File] [Serial Device] [Serial Speed]'
	sys.exit(1)
w, h = 300, 350
buf = ""
ser = serial.Serial(sys.argv[2], sys.argv[3], timeout=0)
ee = ecore.evas.SoftwareX11(w=w, h=h)
ee.title = "Ardy"
canvas = ee.evas
edje_file = os.path.join(os.path.dirname(sys.argv[0]), sys.argv[1])

#Setup Edje Groups
try:
   main = edje.Edje(canvas, file=edje_file, group="Arduino")
except Exception, e:
   raise SystemExit("Failed to load Arduino edje file: %s" % edje_file)
main.size = canvas.size
main.show()
ee.data["main"] = main

#Send into Edje
def emitter(sig):
	main.signal_emit(sig, "arduino")

def serialread(fdh, ser):
	b = ser.inWaiting()
	buf = ser.read(b)
	emitter(buf)
	return 1
	
#Read the Edje
def pressed(button, signal, source):
	ser.write(source)

main.signal_callback_add("clicked", "*", pressed)
ecore.fd_handler_add(ser.fileno(), ecore.ECORE_FD_READ, serialread, ser)

#Make it resize
def resize(ee):
   r = ee.evas.rect
   ee.data["main"].size = r.size

ee.callback_resize = resize

#Clean up on quit
def quit(ee):
   ecore.main_loop_quit()

ee.callback_delete_request_set(quit)

#Launch!
ee.show()
ecore.main_loop_begin()
